# CHANGELOG

### [0.6.3] - 2020-09-22

- Доработка проверки периодов. Если формат периода отчета отличается от описанного формата в документации. Происходит попытка конвертации его допустимый. Механизм конвертации должен полностью повторять аналогичный в оффициальной программе от РосСтата.
- Вернул на место проверку формата значений ячеек. Удалил по невнимательности.


### [0.6.2] - 2020-09-21

- Доработка проверок формата строк и значений в графах:
    - Реализовал пропущенную проверку строки с типом 5. Выяснил, что проверки с типом 4 и 5 выполняются над спецификами строк, а не над значениями в графах.
    - В классе `FormatChecker` выделил обработку строки и значения в графе с выбором метода проверки в отдельные методы. Выполнил небольшой рефакторинг.
    - В классе `Schema` добавил парсинг специфик в отдельный словарь и переработал парсинг справочников, так как нужно учитывать все атрибуты в нодах term.
- Добавил лицензию.

### [0.6.1] - 2020-09-17

- Реализовал следующие проверки:
    - Наличия в отчёте разделов в соответствии со схемой.
    - Формат ОКПО указанного в отчете в блоке title.
    - Формат года указанного в отчете.

### [0.6.0] - 2020-09-16

- Добавил отчету и строкам свойства blank. Положительное значение у строки говорит о том, что в строке нет граф. У отчёта, о том, что во всём отчете нет ни одной графы, соответственно.
    - Пустой отчет теперь не проверяется, вернётся пустой список ошибок.
- Специфика вида "XX" у строки отчёта, теперь считается как удовлетворяющая любому значению специфики в контроле.
- При проверке контроля, создаваемые элементы принимают параметр-признак пустой строки.
- Переработал механизм логических проверок в классе `ElemLogic`.
    - Признаки скаляра и "заглушки" устратили свою силу, но веременно остануться в коде, пока не будет уверенности в их полной бесполезности.
    - Метод проверки возможности проведения логического контроля теперь возвращает отрицательный результат только в одном случае. Если проверяемая формула является условием (condition), оператор проверки не относиться к логическим (or, and) и оба элемента являются "заглушками" из пустой строки. Интерпретируется это как ошибка проведения логического контроля.
    - Исправил неправильный результат проверок если в формуле есть логический оператор "or".

### [0.5.1] - 2020-09-15

- Исправил суммирование элементов.
- Коды секций/строк/графов схемы теперь тоже проходят трансформацию `строка -> число -> строка`, так как и в схемах замечены коды вида "01".
- Исправил добавление в список ошибок сообщения о непредвиденной ошибке проверки формата ячейки.
- Исправил установку погрешности для условий (condition).

### [0.5.0] - 2020-09-11

- Вновь переработал инициализацию элементов из за проблем возникающих в редких случаях когда в формуле есть проверки между элементами, значения осей которых равно "*".
- Добавил в класс `Schema` параметр с размерностью (dimension), заполняющийся при парсинге схемы. Имеет формат {"1": ["1", "2"]}, где ключ - код секции, значение - список возможных кодов колонок.
    - Параметр передаётся в `ControlChecker` и учитывается при проверке в случаях когда значение по оси колонок равно - "*".
- В классе `Section` методу items добавил параметр codes и specs, что позволило полностью убрать итерацию по списку кодов внутрь самого класса. В классе `Row` аналогичные изменения.
- Переработал проверку формул в `PeriodClause`. В некоторых схемамх есть формулы по формату отличающиеся от описанного в документации (прим. `(&NP=3 or &NP=6 or &NP=9)`). Теперь для всех формул кроме проверки на вхождение в список единый механизм. Нормализация строки, разбиение на отдельные части, сборка с подстановкой проверяемого значения и выполнение.
- Добавил класс `ControlParams` собравший в себя все параметры передаваемые между элементами при проверке.
- В классе `Report` атрибут _period_type теперь по умолчанию None.
    - Убрана проверка периода если он не был определен.
- Добавил параметр для пропуска предупреждении о нереализованной проверке контролей со значениями за прошлый период.
- Исправил ошибку при которой могло происходить деление на None.

### [0.4.5] - 2020-09-01

- Поправил ошибку при которой контроль, который не должен был пройти, проходил из-за положительной проверки погрешности. Теперь погрешность по умолчанию равна -1.
- Исправил получение idp из корня шаблона. По аналогии с ошибкой #2.
- Переделал проверку полей блока title и добавил проверку значений и наличия обязательного поля.
- Сделал проверку дубликатов строк.

### [0.4.4] - 2020-08-31

- Исправил получение периода из отчета если передан отчёт типа `lxml.etree._Element` ([Issue #2](https://github.com/WoolenSweater/rosstat-flc/issues/2)).
- Исправил проверку периода контроля для формулы вида `(&NP in(6))` с 1 элементом в списке ([Issue #3](https://github.com/WoolenSweater/rosstat-flc/issues/3)).
- Исправил вызов метода `_apply_funcs` у элемента `ElemSelector`. Забыл передать параметры fault и precision ([Issue #4](https://github.com/WoolenSweater/rosstat-flc/issues/4)).
- Добавил проверку использования в формуле контролей элементов со значениями за прошлый период. Возвращаю сообщение об ошибке, так как такой функционал не реализован и неизвестно когда это удастся сделать.

### [0.4.3] - 2020-08-31

- Исправил парсинг отчета в тайтле которого есть ноды без атрибута value ([Issue #1](https://github.com/WoolenSweater/rosstat-flc/issues/1)).
- Исключил парсинг "пустых" контролей, выполняя strip у формулы перед проверкой ([Issue #5](https://github.com/WoolenSweater/rosstat-flc/issues/5)).
- Исправил выполнение контролей с элементами со спецификой равной "0", добавив её к игнорируемым.
- Исправил выполнение контролей с функцией ABS, повысив её приоритет над математическими операциями.

### [0.4.2] - 2020-08-28

- Добавил указание обязательности в сообщение о непройденном контроле.
- Добавил проверку погрешности при проверке выполнения логического условия.

### [0.4.1] - 2020-08-27

- Добавил исключений и переработал места возбуждения и отлова их.
- Рефакторинг.
    - Написал док-стринги к методам чекеров и методам парсера-лексера у которых их не было.
    - Разделил чекеры и перенес в отдельную директорию.
    - Рефакторинг класса Schema.
    - Рефакторинг класса ControlChecker.
- В методах проверки логических условий класса PeriodClause исправил ошибку при проверке оператора равенста "=" для замены его на "==".

### [0.4.0] - 2020-08-26

- Реализовал проверку формата заполнения полей отчета всех типов кроме 5-ого. Пока не ясно как она должна проводится.
- Исправил проверку полей которые обязательны для заполнения (inputType="1"). Исключение составляют мультистроки. Для них похоже должна быть своя логика проверки.

### [0.3.0] - 2020-08-24

- Реализовал проверку периодов:
    - Шаблона и отчета.
    - Условия выполнения контроля.
- Исправил ошибку неполного заполнения строки "заглушками" если её нет в отчёте.
- Иcправил парсинг формул контролей вида SUM{[][][]}+SUM{[][][]}. Приоритет функции SUM должен быть выше чем у математических операций.

### [0.2.1] - 2020-08-21

- Проверка условий для проведения контроля теперь не добавляется в список ошибок. Метод возвращает булево значение.
- Добавил в элемент атрибуты определяющие его тип как "заглушку" или скаляра. Если оба атрибута False, то это реальное значение из отчёта.
- Поправил создание элементов. Отталкиваюсь не от размерности, а от необходимых для контроля значений. Отсутствующие в отчете значения, как и планировалось, замещаются элементом со значением ноль и признаком, что он "заглушка".
- Перед проверкой выполнения логических условий теперь проверяются "типы" элементов. Логический контроль не выполняется если оба элемента "заглушки", либо один элемент "заглушка", а другой скаляр.
- Поправил выполнение операций round и isnull. Забыл про возможность наличия аргумента для обрезки значения.
- Поправил лексер-парсер для формул где метод isnull вложен в любой другой.

### 2020-08-20

- Переработал парсинг отчета с учетом мультилайнов.
    - Реализовал вспомогательные дата-классы для секции и строки.
    - Индексы секций/строк/графов теперь трансформируются сначала в число (если это возможно), затем обратно в строку. Так как есть ключи вида "01", однако в формуле "1".
- Изменил формат и тип сообщения о непройденном контроле.
- Доработал инициализацию элементов языка контролей.
    - Координаты и специфики теперь в множестве типа set.
    - Создание элементов проиходит отталкиваясь от отчета. Отсутствующие элементы НЕ замещаются элементом со значением None. Это временное решение так как надо отталкиваться от размерности указанной в схеме и замещать отсутствующие элементами со значением 0. В ближайшее время будет переделано.
- Поправил/оптимизировал лексер-парсер так как допускается использование функции SUM без круглых скобок.
- Прочие мелкие исправления.

### 2020-08-18

- Исправил ошибку при работе с элементами значение которых None. Причина возникновения, отсутствие метода isnull в формуле для незаполненной или полностью отсутствующей ячейки. В таком случае её значение так и будет оставаться None при проведении всех операций, а при сравнении будет интерпритироваться как ошибка.
- Исправил округление по умолчанию. Исходя из документации оно должно применяться к значениям элементов только при сравнениях их друг с другом.
- Исправил парсинг контролей в которых есть числа с запятой.
- Добавил setup.py


### Прошлое

- Готов лексер и парсер для разбора формул контролей.
- Готовы парсеры для разбора отчета и шаблона с проверками.
- Сделал классы болванки для проверки формата заполнения ячеек и прогона контролей.
